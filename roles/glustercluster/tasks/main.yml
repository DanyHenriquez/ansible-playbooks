- name: Update package cache
  apt: update_cache=yes

- name: Ensure software is at the latest version
  apt: pkg={{ item }} state=latest
  with_items:
    - sudo
    - glusterfs-server

- name: Gluster peer probe
  command: /usr/sbin/gluster peer probe {{ item }}
  with_items:
    - '{{ play_hosts }}'

- file: path=/mnt/html state=directory

- name: Create mountpoint
  shell: /usr/sbin/gluster volume create html replica 2 transport tcp {% for node in groups['dbservers'] %}{{ node }}:/mnt/html {% endfor %} force

- name: Make sure the glusterfs filesystem is present
  mount: name=/usr/share/nginx/html fstype=glusterfs src={{ hostvars[inventory_hostname]['ansible_all_ipv4_addresses'][0] }}:www state=present

- name: Mount the glusterfs filesystem
  mount: name=/usr/share/nginx/html fstype=glusterfs src={{ hostvars[inventory_hostname]['ansible_all_ipv4_addresses'][0] }}:www state=mounted